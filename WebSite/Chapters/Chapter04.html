---
Created by: Chris Barbour 2014
---
<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="GekoOS : The Geko Operating System" />
    <meta name="chapter" content="4" />

    <link rel="stylesheet" type="text/css" media="screen" href="../stylesheets/stylesheet.css">

    <title>GekoOS - Chapter 4</title>
    <!--
    Inline Code
    <SPAN class='icode'>0xAA55</SPAN>
    Dark Inline Code
    <SPAN class='dark icode'>0xAA55</SPAN>
    Block Code
    <PRE><CODE>**code**</CODE></PRE>
    Byte table
    <TABLE class='byte_table'></TABLE>
    Styled Table
    <TABLE class='dir_table'></TABLE>
    Indented Gray Note
    <SECTION class="indent note_content">
      <P>
      </P>
    </SECTION>
    -->
  </head>

  <body>
    <div style="border-radius:5px;position:fixed;left:50%;top:0px;background-color:rgb(240,240,240);border:1px solid rgb(200,200,200);z-index:500;padding:0 10px 0 10px;margin-top:-4px;box-shadow:0px 0px 10px 0px rgba(0,0,0,0.3);">&nbspContents&nbsp<div style="border:4px solid transparent;border-top:1px solid rgba(180,180,180,0.8);border-bottom:4px solid transparent;width:60%;margin:0 auto;margin-top:-2px;"></div></div>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/bobjamin/GekoOS">View on GitHub</a>

          <h1 id="project_title">GekoOS</h1>
          <h2 id="project_tagline">Chapter 04 - The Boot Loader</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/bobjamin/GekoOS/zipball/B04BootLoader01">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/bobjamin/GekoOS/tarball/B04BootLoader01">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        
        <H1>Clean up</H1>
          <P>
            Now we have the ability to load sectors that exist after the boot sector we can start writing the boot loader. Open up the BootSector.asm and remove everthing after the special duo <SPAN class='icode'>0xAA55</SPAN>. We are going to write this in a new file. Also remove the two lines that print out whats present at 0x9000 shown below.
          </P>

<PRE class='red'><CODE class='nasmcode'>    MOV SI, 0X9000
    CALL PrintString16</CODE></PRE>
          <BR>

          <P>
            Replace the above two lines with:
          </P>

<PRE><CODE class='nasmcode'>    JMP WORD 0X00:0X9000</CODE></PRE>
          <BR>

          <P>
            This is an absolute far jump to the location in memory the boot loader will be placed.
          </P>

           <SECTION class="indent note_content">
            <P>
              Note: Make sure to delete everything after the 512th byte in the bootsector otherwise this will be loaded at address 0x9000 and the jump will land there.
            </P>
          </SECTION>

          <H1>The Boot Loader</H1>

            <P>
              Now we can create a separate file where the boot loader code can reside. The reason for creating a second file is not only to separate the code but to allow us to use the ORG directive to point to 0x9000 at the top so that offsets are correct.
              <BR>
              Open up a new text document and save it as BootLoader.asm in the directory C:/GekoOS/BootSector/Asm/. Now edit the file to read:
            </P>

<PRE><CODE class='nasmcode'>[ORG 0X9000]
[BITS 16]

Start:
    MOV SI, MSG
    CALL PrintString16
    CLI
    HLT

%include "Print16.i"

MSG   DB  "HELLO",0</CODE></PRE>
            <BR>

            <P>
              This should look familiar. Its basically the original boot sector from chapter 1. The only difference is that the ORG directive is now pointed at 0x9000. This is usefull.
            </P>

            <H3>The Build Process</H3>

              <P>
                The build process needs to be edited slightly to allow this new file to be assembled. It also needs to concatenate the binary output from both the boot sector and the boot loader together. Luckily this is wee buns.
                <BR>
                Add the following line below the <SPAN class='dark icode'>nasm</SPAN> line in Assemble.bat:
              </P>

<PRE class='dark'><CODE class='dark shellscript'>nasm -f bin -o %BIN%\BootLoader.bin -i %ASMINC% %ASM%\BootLoader.asm</CODE></PRE>
              <BR>

              <P>
                The above line allows the boot loader to be assembled. Now all we need to do is edit the copy line to read:
              </P>
              
<PRE class='dark'><CODE class='dark shellscript'>copy /Y /b %BIN%\BootSector.bin + /b %BIN%\BootLoader.bin %VM%\BootSector.bin</CODE></PRE>              <BR>
        
              <P>
                Double click the Assembler.bat and watch the magic before your eyes.
                <BR>
                Now you have a working boot loader and boot sector for all your 16-bit needs.
              </P>

        <H1>More Interrupts</H1>

          <P>
            We are now in to the big bad world of 16-bit where we can create a lot more than we could a moment ago. The main focus for the boot loader will be to load the kernel, but before we think about that lets add some useful functionality to play with.
            <BR><BR>
            Create a new file called "Screen16.i" and save it in C:\GekoOS\BootSector\Asm\Include. This file will contain some functionality around interacting with the screen output like setting the cursor and clearing the screen. The reason this code will not be placed into the Print16.i file is because if we did that the BootSector would get bigger and possibly overflow. Bad.
          </P>

          <H3>Current Video Mode</H3>

            <P>
              A useful function for getting the current video mode is provided by interrupt 0x10 shown below:
            </P>

            <TABLE class="dir_table">
              <TR>
                <TD colspan='3' style='font-size:medium;font-weight:bold;'>INT 0x10</TD>
              </TR>
              <TR>
                <TH>Register</TH>
                <TH>Value</TH>
                <TH>Description</TH>
              </TR>

              <TR>
                <TD>AH</TD>
                <TD>0X0F</TD>
                <TD>Get Current Video Mode</TD>
              </TR>

              <TR>
                <TH colspan='3' style='text-align:center'>Returns</TH>
              </TR>

              <TR>
                <TD>AL</TD>
                <TD>Byte</TD>
                <TD>Video Mode</TD>
              </TR>
            </TABLE>

            <P>
              We can add this to the Screen.i code as follows, Don't forget to add <SPAN class='icode'>[BITS 16]</SPAN> to the top of the file:
            </P>
<PRE><CODE class='nasmcode'>;Get current video mode in AL
GetVideoMode:
    MOV AH, 0X0F
    INT 0X10
RET</CODE></PRE>
            <BR>

            <P>
              This code will be used later. By default the BIOS loads the processor into video mode 0x03. This means that it is in Text mode and that there are 80 characters across and 25 down. There are many standard video modes including the infamous 0x13 where games have been writen in the distant past but we don't need to get in too deep with this as we will want to write our own display drivers later in 32-bit land.
            </P>

          <H3>Get Rows and Columns</H3>

            <P>
              Useing the above mothod we can extrapolate the number of rows and columns there are, Currently we will only check for the default but this can be expanded at any time, its there for flexability. Place the following code after the previous snippet:
            </P>

<PRE><CODE class='nasmcode'>;Get Rows and Columns in BX and AX
GetRowsAndColumns:
  CALL GetVideoMode
  CMP AL, 0X03    ;Default is 0x03
  JE  .Default
RET
.Default:
  MOV DL, 80      ;Rows
  MOV DH, 25      ;Columns
RET</CODE></PRE>
            <BR>

            <P>
              The aim of the above functions is to give us information about the screen content so that it can be used later. The next snippet shows one use of these functions. It clears the screen by looking up the number of rows and columns and then sets the cursor to the top left corner.
              <BR>
              The BIOS also provides us with a set cursor function shown below:
            </P>
            <H3>Set Cursor Position</H3>
             <TABLE class="dir_table">
              <TR>
                <TD colspan='3' style='font-size:medium;font-weight:bold;'>INT 0x10</TD>
              </TR>
              <TR>
                <TH>Register</TH>
                <TH>Value</TH>
                <TH>Description</TH>
              </TR>

              <TR>
                <TD>AH</TD>
                <TD>0X02</TD>
                <TD>Set Cursor Position</TD>
              </TR>

              <TR>
                <TD>BH</TD>
                <TD>Byte</TD>
                <TD>The Page number</TD>
              </TR>

              <TR>
                <TD>DH</TD>
                <TD>Byte</TD>
                <TD>The Row (Y)</TD>
              </TR>

              <TR>
                <TD>DL</TD>
                <TD>Byte</TD>
                <TD>The Column (X)</TD>
              </TR>
            </TABLE>
            <P>
              We can tidy this up by adding the following function:
            </P>

<PRE><CODE class='nasmcode'>;16-bit Set Cursor method
;X = DH, Y = DL; PAGE = BH
SetCursorPos:
  MOV AH, 0X02
  INT 0X10
RET</CODE></PRE>
            <BR>

          <H3>Clear Screen</H3>
          <P>
            Now we have enough information to clear the screen without having to hard code everything. To do this we can use another handy BIOS interrupt function from 0x10.
          </P>

          <TABLE class="dir_table">
              <TR>
                <TD colspan='3' style='font-size:medium;font-weight:bold;'>INT 0x10</TD>
              </TR>
              <TR>
                <TH>Register</TH>
                <TH>Value</TH>
                <TH>Description</TH>
              </TR>

              <TR>
                <TD>AH</TD>
                <TD>0X06</TD>
                <TD>Scroll Up Window</TD>
              </TR>

              <TR>
                <TD>AL</TD>
                <TD>Byte</TD>
                <TD>0 for clear, uses CX and DX, otherwise no. lines to scroll</TD>
              </TR>

              <TR>
                <TD>BH</TD>
                <TD>Byte</TD>
                <TD>Background and Foreground Colors</TD>
              </TR>

              <TR>
                <TD>CH</TD>
                <TD>Byte</TD>
                <TD>Top Row</TD>
              </TR>

              <TR>
                <TD>CL</TD>
                <TD>Byte</TD>
                <TD>Left Column</TD>
              </TR>

              <TR>
                <TD>DH</TD>
                <TD>Byte</TD>
                <TD>Bottom Row</TD>
              </TR>

              <TR>
                <TD>DL</TD>
                <TD>Byte</TD>
                <TD>Right Column</TD>
              </TR>
          </TABLE>

          <P>
            The following code shows the last method for this chapter, the clear screen method:
          </P>

<PRE><CODE class='nasmcode'>;16-bit Clear screen method
;Clears the screen to the color in CH
;and sets cursor to 0 on page in BH
ClearScreen:
  PUSH BX
  CALL GetRowsAndColumns  ;Sets DL and DH
  MOV AL, 0X00            ;Clear method
  MOV AH, 0X06            ;Clear function
  MOV BH, CH              ;Set fore and back color
  XOR CX, CX              ;Start at 0, 0 
  INT 0X10                ;Clear
  POP BX                  ;Get page
  XOR DX, DX              ;Set cursor to 0, 0
  CALL SetCursorPos
RET</CODE></PRE>
          <BR>

          <P>
            Last, Go to the Boot Loader and edit it to read:
          </P> 

<PRE><CODE class='nasmcode'>[ORG 0X9000]
[BITS 16]

Start:
    MOV CH, 0X0F      ;Set Color to White on Black
    MOV BH, 0X0       ;Page 0
    CALL ClearScreen  ;Clear Screen
    MOV SI, MSG       ;Print HELLO
    CALL PrintString16

    CLI
    HLT

%include "Print16.i"
%include "Screen16.i"

MSG   DB  "HELLO",0</CODE></PRE>
          <BR>

          <P>
            Now when you build this you will see only the word, HELLO at the top left of the screen.
            <BR>
            <BR>
            Play about with the color byte to see different colors. The high 4 bits are the background and the low 4 bits are the foreground. The background also has a special feature when the highest bit is set it will cause the text to blink.
          </P>

        <H2>Utilities</H2>

            <P>
              This next section simply adds in functionality that will allow us to view memory at any time, this will be useful for debugging. I created a file called Utilites16.i and added it to the Include directory. All it does is provide a way of printing hexadecimal values.
            </P>

<PRE><CODE class='nasmcode'>[BITS 16]
;Print Hex Character
PrintHexChar16: 
        PUSH AX
        SHR AL, 4
        CALL PrintHex4Bit16
        POP AX
        SHL AL, 4
        SHR AL, 4
        CALL PrintHex4Bit16
RET

;Print 4 bit Hex value stored in AL
PrintHex4Bit16: 
        CMP AL, 0XA
        JL .Print
        ADD AL, 0X07
  .Print:   
        ADD AL, 0X30
        CALL PrintChar16
RET</CODE></PRE>
            <BR>

        <H2>The Keyboard</H2>

            <P>
             [[FILL OUT CONTENT]]
            </P>

<PRE><CODE class='nasmcode'>[[FILL OUT CODE]]</CODE></PRE>
            <BR>

      </section>  
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <div style='float:right;font-size:30px;color:rgb(240,240,240);'><a id='prev'><</a>&nbsp&nbsp<a id='next'>></a></div>
        <p class="copyright">GekoOS maintained by <a href="https://github.com/bobjamin">Chris Barbour</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    
    <script src="../javascripts/util.js"></script>

  </body>
</html>
