---
Created by: Chris Barbour 2014
---
<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="GekoOS : The Geko Operating System" />
    <meta name="chapter" content="4" />

    <link rel="stylesheet" type="text/css" media="screen" href="../stylesheets/stylesheet.css">

    <title>GekoOS - Chapter 4</title>
    <!--
    Inline Code
    <SPAN class='icode'>0xAA55</SPAN>
    Dark Inline Code
    <SPAN class='dark icode'>0xAA55</SPAN>
    Block Code
    <PRE><CODE>**code**</CODE></PRE>
    Byte table
    <TABLE class='byte_table'></TABLE>
    Styled Table
    <TABLE class='dir_table'></TABLE>
    Indented Gray Note
    <SECTION class="indent note_content">
      <P>
      </P>
    </SECTION>
    -->
  </head>

  <body>
    <div style="border-radius:5px;position:fixed;left:50%;top:0px;background-color:rgb(240,240,240);border:1px solid rgb(200,200,200);z-index:500;padding:0 10px 0 10px;margin-top:-4px;box-shadow:0px 0px 10px 0px rgba(0,0,0,0.3);">&nbspContents&nbsp<div style="border:4px solid transparent;border-top:1px solid rgba(180,180,180,0.8);border-bottom:4px solid transparent;width:60%;margin:0 auto;margin-top:-2px;"></div></div>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/bobjamin/GekoOS">View on GitHub</a>

          <h1 id="project_title">GekoOS</h1>
          <h2 id="project_tagline">Chapter 04 - The Boot Loader</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/bobjamin/GekoOS/zipball/B04BootLoader01">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/bobjamin/GekoOS/tarball/B04BootLoader01">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        
        <H1>Clean up</H1>
          <P>
            Now we have the ability to load sectors that exist after the boot sector we can start writing the boot loader. Open up the BootSector.asm and remove everthing after the special duo <SPAN class='icode'>0xAA55</SPAN>. We are going to write this in a new file. Also remove the two lines that print out whats present at 0x9000 shown below.
          </P>

<PRE class='red'><CODE class='nasmcode'>    MOV SI, 0X9000
    CALL PrintString16</CODE></PRE>
          <BR>

          <P>
            Replace the above two lines with:
          </P>

<PRE><CODE class='nasmcode'>    JMP WORD 0X00:0X9000</CODE></PRE>
          <BR>

          <P>
            This is an absolute far jump to the location in memory the boot loader will be placed.
          </P>

           <SECTION class="indent note_content">
            <P>
              Note: Make sure to delete everything after the 512th byte in the bootsector otherwise this will be loaded at address 0x9000 and the jump will land there.
            </P>
          </SECTION>

          <H1>The Boot Loader</H1>

            <P>
              Now we can create a separate file where the boot loader code can reside. The reason for creating a second file is not only to separate the code but to allow us to use the ORG directive to point to 0x9000 at the top so that offsets are correct.
              <BR>
              Open up a new text document and save it as BootLoader.asm in the directory C:/GekoOS/BootSector/Asm/. Now edit the file to read:
            </P>

<PRE><CODE class='nasmcode'>[ORG 0X9000]
[BITS 16]

Start:
    MOV SI, MSG
    CALL PrintString16
    CLI
    HLT

%include "Print16.i"

MSG   DB  "HELLO",0</CODE></PRE>
            <BR>

            <P>
              This should look familiar. Its basically the original boot sector from chapter 1. The only difference is that the ORG directive is now pointed at 0x9000. This is usefull.
            </P>

            <H3>The Build Process</H3>

              <P>
                The build process needs to be edited slightly to allow this new file to be assembled. It also needs to concatenate the binary output from both the boot sector and the boot loader together. Luckily this is wee buns.
                <BR>
                Add the following line below the <SPAN class='dark icode'>nasm</SPAN> line in Assemble.bat:
              </P>

<PRE class='dark'><CODE class='dark shellscript'>nasm -f bin -o %BIN%\BootLoader.bin -i %ASMINC% %ASM%\BootLoader.asm</CODE></PRE>
              <BR>

              <P>
                The above line allows the boot loader to be assembled. Now all we need to do is edit the copy line to read:
              </P>
              
<PRE class='dark'><CODE class='dark shellscript'>copy /Y /b %BIN%\BootSector.bin + /b %BIN%\BootLoader.bin %VM%\BootSector.bin</CODE></PRE>              <BR>
        
              <P>
                Double click the Assembler.bat and watch the magic before your eyes.
                <BR>
                Now you have a working boot loader and boot sector for all your 16-bit needs.
              </P>

        <H1>More Interrupts</H1>

          <P>
            We are now in to the big bad world of 16-bit where we can create a lot more than we could a moment ago. The main focus for the boot loader will be to load the kernel, but before we think about that lets add some useful functionality to play with.
            <BR><BR>
            Create a new file called "Screen16.i" and save it in C:\GekoOS\BootSector\Asm\Include. This file will contain some functionality around interacting with the screen output like setting the cursor and clearing the screen. The reason this code will not be placed into the Print16.i file is because if we did that the BootSector would get bigger and possibly overflow. Bad.
          </P>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <div style='float:right;font-size:30px;color:rgb(240,240,240);'><a id='prev'><</a>&nbsp&nbsp<a id='next'>></a></div>
        <p class="copyright">GekoOS maintained by <a href="https://github.com/bobjamin">Chris Barbour</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    
    <script src="../javascripts/util.js"></script>

  </body>
</html>
